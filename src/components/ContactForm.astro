---
interface Props {
  subtitle?: string;
  autofocus?: boolean;
}

const {
  subtitle = "Drop me a note and I'll get back to you as soon as I can. Typically within a day.",
  autofocus = false,
} = Astro.props;

import Button from "./Button.astro";
---

<div class="contact-form-wrapper">
  <div class="form-state">
    <p class="subtitle">
      {subtitle}
    </p>
    <form action="https://submit-form.com/R7bwjb69d" class="support-form">
      <input
        type="text"
        id="name"
        name="name"
        placeholder="Name"
        required
        autofocus={autofocus}
      />
      <input type="email" id="email" name="email" placeholder="Email" required />
      <textarea id="message" name="message" placeholder="Message" required
      ></textarea>
      <Button type="submit">Send</Button>
    </form>
  </div>

  <div class="success-state" hidden>
    <p class="subtitle">Message sent! I'll get back to you soon.</p>
    <p>Got a few more minutes? I'd really appreciate your thoughts in a quick survey.</p>
    <Button href="/survey">Take the Survey</Button>
  </div>
</div>

<script>
  const wrapper = document.querySelector('.contact-form-wrapper')!;
  const form = wrapper.querySelector('form')!;
  const formState = wrapper.querySelector('.form-state') as HTMLElement;
  const successState = wrapper.querySelector('.success-state') as HTMLElement;
  const IDENTITY_KEY = 'bleep_user';

  // Restore saved identity
  try {
    const identity = JSON.parse(localStorage.getItem(IDENTITY_KEY) || '{}');
    if (identity.name) (form.querySelector('#name') as HTMLInputElement).value = identity.name;
    if (identity.email) (form.querySelector('#email') as HTMLInputElement).value = identity.email;
  } catch {}

  // Save name/email on input
  form.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.name === 'name' || target.name === 'email') {
      const identity = JSON.parse(localStorage.getItem(IDENTITY_KEY) || '{}');
      identity[target.name] = target.value;
      localStorage.setItem(IDENTITY_KEY, JSON.stringify(identity));
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form));
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
        },
      });
      if (!res.ok) throw new Error();
      formState.hidden = true;
      successState.hidden = false;
    } catch {
      form.submit();
    }
  });
</script>

<style>
  .subtitle {
    font-size: 1.2rem;
    font-weight: 500;
    margin-bottom: 2rem;
    color: var(--body-secondary-foreground-color);
  }

  form {
    display: flex;
    flex-direction: column;
    width: 100%;
    gap: 1em;
  }

  input[type="text"],
  input[type="email"],
  textarea,
  button {
    padding: 0.5em 0.75em;
    border-radius: 0.75em;
    font-size: 1rem;
  }

  input[type="text"]:focus,
  input[type="email"]:focus,
  textarea:focus,
  button:focus {
    outline: none !important;
    border-color: var(--color-accent);
    caret-color: var(--color-accent);
  }

  input[type="text"],
  input[type="email"],
  textarea {
    border: 1px solid #e5e5e5;
  }

  textarea {
    resize: vertical;
    min-height: 8em;
  }

  @media (prefers-color-scheme: dark) {
    input[type="text"],
    input[type="email"],
    textarea {
      border-color: #333;
    }
  }

  form button {
    cursor: pointer;
    border: 1px solid rgb(from var(--body-foreground-color) r g b / 0.04);
    margin: 0px !important;
  }

  .success-state p {
    margin-bottom: 1rem;
  }
</style>
